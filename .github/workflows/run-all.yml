# Run All CI - Runs all workflows in sequence
# Use this for initial setup or full refresh of status page

name: Run All CI

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  run-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0  # Fetch all history for all branches

      - name: Configure Git
        run: |
          git config user.name "Upptime Bot"
          git config user.email "upptime@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 1: Check uptime for all endpoints
      - name: "Step 1/9: Check Uptime"
        uses: upptime/uptime-monitor@master
        with:
          command: "update"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 2: Test WebSocket connection (does not block workflow on failure)
      - name: "Step 2/9: Test WebSocket"
        run: |
          npm install ws
          node .github/scripts/test-websocket.js
        env:
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}
          WEBSOCKET_RESULT_FILE: ${{ github.workspace }}/websocket-result.json
        continue-on-error: true

      # Step 3: Update WebSocket history from script result
      - name: "Step 3/9: Update WebSocket History"
        run: node .github/scripts/update-websocket-history.js
        env:
          WEBSOCKET_RESULT_FILE: ${{ github.workspace }}/websocket-result.json

      # Step 4: Record response times
      - name: "Step 4/9: Record Response Times"
        uses: upptime/uptime-monitor@master
        with:
          command: "response-time"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 5: Generate graphs
      - name: "Step 5/9: Generate Graphs"
        uses: upptime/uptime-monitor@master
        with:
          command: "graphs"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 6: Update summary
      - name: "Step 6/9: Update Summary"
        uses: upptime/uptime-monitor@master
        with:
          command: "summary"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 7: Build static site
      - name: "Step 7/9: Build Static Site"
        uses: upptime/uptime-monitor@master
        with:
          command: "site"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 8: Apply custom theme
      - name: "Step 8/9: Apply Custom Theme"
        run: |
          cp -f custom-theme/global.css ./site/__sapper__/export/global.css
          cp -rf custom-theme/themes/* ./site/__sapper__/export/themes/

      # Step 9: Deploy to GitHub Pages
      - name: "Step 9/9: Deploy to GitHub Pages"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAT }}
          publish_dir: ./site/__sapper__/export
          publish_branch: gh-pages
          force_orphan: true
