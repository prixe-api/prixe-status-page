# Run All CI - Runs all workflows in sequence
# Use this for initial setup or full refresh of status page

name: Run All CI

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  run-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0  # Fetch all history for all branches

      - name: Configure Git
        run: |
          git config user.name "Upptime Bot"
          git config user.email "upptime@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 1: Check uptime (1st run)
      - name: "Step 1/12: Check Uptime (1st run)"
        uses: upptime/uptime-monitor@master
        with:
          command: "update"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      - name: "Step 2/12: Save first run history"
        run: |
          mkdir -p history_first_run
          cp history/*.yml history_first_run/ 2>/dev/null || true

      - name: "Step 3/12: Check Uptime (2nd run)"
        uses: upptime/uptime-monitor@master
        with:
          command: "update"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      - name: "Step 4/12: Merge history (down only if both runs failed)"
        run: node .github/scripts/merge-history-retry.js
        env:
          HISTORY_FIRST_RUN_DIR: ${{ github.workspace }}/history_first_run

      # Step 5: Test WebSocket connection (does not block workflow on failure)
      - name: "Step 5/12: Test WebSocket"
        run: |
          npm install ws
          node .github/scripts/test-websocket.js
        env:
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}
          WEBSOCKET_RESULT_FILE: ${{ github.workspace }}/websocket-result.json
        continue-on-error: true

      # Step 3: Update WebSocket history from script result
      - name: "Step 6/12: Update WebSocket History"
        run: node .github/scripts/update-websocket-history.js
        env:
          WEBSOCKET_RESULT_FILE: ${{ github.workspace }}/websocket-result.json

      # Step 7: Record response times
      - name: "Step 7/12: Record Response Times"
        uses: upptime/uptime-monitor@master
        with:
          command: "response-time"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 8: Generate graphs
      - name: "Step 8/12: Generate Graphs"
        uses: upptime/uptime-monitor@master
        with:
          command: "graphs"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 9: Update summary
      - name: "Step 9/12: Update Summary"
        uses: upptime/uptime-monitor@master
        with:
          command: "summary"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 10: Build static site
      - name: "Step 10/12: Build Static Site"
        uses: upptime/uptime-monitor@master
        with:
          command: "site"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}
          PRIXE_PRO_API_KEY: ${{ secrets.PRIXE_PRO_API_KEY }}

      # Step 11: Apply custom theme
      - name: "Step 11/12: Apply Custom Theme"
        run: |
          cp -f custom-theme/global.css ./site/__sapper__/export/global.css
          cp -rf custom-theme/themes/* ./site/__sapper__/export/themes/

      # Step 12: Deploy to GitHub Pages
      - name: "Step 12/12: Deploy to GitHub Pages"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAT }}
          publish_dir: ./site/__sapper__/export
          publish_branch: gh-pages
          force_orphan: true
