# Run All CI - Runs all workflows in sequence
# Use this for initial setup or full refresh of status page

name: Run All CI

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  run-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0  # Fetch all history for all branches

      - name: Configure Git
        run: |
          git config user.name "Upptime Bot"
          git config user.email "upptime@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 1: Check uptime for all endpoints
      - name: "Step 1/7: Check Uptime"
        uses: upptime/uptime-monitor@v1.41.0
        with:
          command: "update"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}

      # Step 2: Test WebSocket connection
      - name: "Step 2/7: Test WebSocket"
        run: |
          npm install ws
          node .github/scripts/test-websocket.js
        env:
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}

      # Step 3: Record response times
      - name: "Step 3/7: Record Response Times"
        uses: upptime/uptime-monitor@v1.41.0
        with:
          command: "response-time"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}

      # Step 4: Generate graphs
      - name: "Step 4/7: Generate Graphs"
        uses: upptime/uptime-monitor@v1.41.0
        with:
          command: "graphs"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}

      # Step 5: Update summary
      - name: "Step 5/7: Update Summary"
        uses: upptime/uptime-monitor@v1.41.0
        with:
          command: "summary"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}

      # Step 6: Build static site
      - name: "Step 6/7: Build Static Site"
        uses: upptime/uptime-monitor@v1.41.0
        with:
          command: "site"
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          PRIXE_API_KEY: ${{ secrets.PRIXE_API_KEY }}

      # Step 7: Deploy to GitHub Pages
      - name: "Step 7/7: Deploy to GitHub Pages"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAT }}
          publish_dir: ./site/__sapper__/export
          publish_branch: gh-pages
          force_orphan: true
